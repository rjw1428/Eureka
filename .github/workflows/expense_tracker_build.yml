name: Expense Tracker Build Pipeline

on:
    pull_request:
        types: [closed]
        branches: [main]
        paths:
            - "flutter/expense_tracker/**"
        # # Alternatively, you can use the PR title pattern
        # if: contains(github.event.pull_request.title, '[ExpenseTracker]')

env:
    FLUTTER_VERSION: "3.24.3" # Adjust to your Flutter version

jobs:
    build_ios:
        name: Build iOS App
        runs-on: macos-latest
        if: github.event.pull_request.merged == true

        steps:
            - uses: actions/checkout@v3

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: ${{ env.FLUTTER_VERSION }}
                  channel: "stable"

            - name: Install Apple Certificate
              uses: apple-actions/import-codesign-certs@v1
              with:
                  p12-file-base64: ${{ secrets.IOS_P12_CERTIFICATE }}
                  p12-password: ${{ secrets.IOS_P12_PASSWORD }}

            - name: Install Provisioning Profile
              env:
                  PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE }}
              run: |
                  PP_PATH=$RUNNER_TEMP/profile.mobileprovision
                  echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode > $PP_PATH
                  mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
                  cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

            - name: Flutter Pub Get
              working-directory: ./flutter/expense_tracker # Adjust this path
              run: flutter pub get

            - name: Build iOS
              working-directory: ./flutter/expense_tracker # Adjust this path
              run: flutter build ios --release --no-codesign

            - name: Build IPA
              working-directory: ./flutter/expense_tracker/ios # Adjust this path
              run: |
                  xcodebuild -workspace Runner.xcworkspace \
                    -scheme Runner \
                    -configuration Release \
                    -archivePath $RUNNER_TEMP/Runner.xcarchive \
                    clean archive
                  xcodebuild -exportArchive \
                    -archivePath $RUNNER_TEMP/Runner.xcarchive \
                    -exportOptionsPlist exportOptions.plist \
                    -exportPath $RUNNER_TEMP/ios_build

            - name: Upload iOS Build
              uses: actions/upload-artifact@v3
              with:
                  name: ios-build
                  path: ${{ runner.temp }}/ios_build

    build_android:
        name: Build Android App
        runs-on: ubuntu-latest
        if: github.event.pull_request.merged == true

        steps:
            - uses: actions/checkout@v3

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: "stable"

            - name: Decode Keystore File
              env:
                KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
              run: |
                echo $KEYSTORE_BASE64 | base64 -d > android/app/upload-keystore.jks

            - name: Update key.properties
              run: |
                echo "storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" > android/key.properties
                echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
                echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
                echo "storeFile=keystore/upload-keystore.jks" >> android/key.properties
      
            - name: Flutter Pub Get
              working-directory: ./flutter/expense_tracker # Adjust this path
              run: flutter pub get

            - name: Build Android
              working-directory: ./flutter/expense_tracker # Adjust this path
              env:
                  KEY_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
                  KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
                  KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
              run: flutter build appbundle

            - name: Upload Android Build
              uses: actions/upload-artifact@v3
              with:
                  name: android-build
                  path: path/to/flutter/project/build/app/outputs/bundle/release/app-release.aab # Adjust this path
